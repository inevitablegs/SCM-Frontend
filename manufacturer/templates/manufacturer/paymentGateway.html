<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escrow Payment System | Supply Chain Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
    font-family: 'Poppins', sans-serif;
    background-color: #f9fafb;
}

.dashboard-card {
    transition: all 0.3s ease;
    transform-origin: center;
}

.dashboard-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.button-primary {
    transition: all 0.3s ease;
    background-color: #3b82f6;
    color: white;
    font-weight: 500;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.button-primary:hover {
    background-color: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 6px 8px rgba(37, 99, 235, 0.3);
}

.button-primary:disabled {
    background-color: #93c5fd;
    cursor: not-allowed;
}

.status-success {
    color: #10b981;
    font-weight: 500;
}

.status-error {
    color: #ef4444;
    font-weight: 500;
    white-space: pre-line;
}

.debug-console {
    background-color: #1f2937;
    color: #e5e7eb;
    padding: 1rem;
    border-radius: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    font-family: Consolas, Monaco, "Andale Mono", monospace;
    font-size: 0.875rem;
}

.debug-timestamp {
    color: #9ca3af;
    font-size: 0.75rem;
}

.debug-message {
    margin-left: 0.5rem;
}

.debug-error {
    color: #f87171;
}

.step-container {
    position: relative;
}

.step-container::before {
    content: "";
    position: absolute;
    left: 2.5rem;
    top: 3rem;
    bottom: 0;
    width: 1px;
    background-color: #d1d5db;
    z-index: 0;
}

.step-container:last-child::before {
    display: none;
}

.step-number {
    background-color: #3b82f6;
    color: white;
    width: 2rem;
    height: 2rem;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    z-index: 10;
    position: relative;
}

@media (max-width: 768px) {
    .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 50;
    }
    
    .nav-menu.active {
        display: block;
    }
}
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-2">
                    <div class="flex items-center justify-center h-10 w-10 rounded-md bg-blue-600 text-white">
                        <i class="fas fa-link text-lg"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-blue-700">Supply<span class="text-gray-700">Chain</span></h1>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex space-x-8 nav-menu">
                    <a href="{% url 'home' %}" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">Home</a>
                    <a href="{% url 'about' %}" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">About</a>
                    <a href="{% url 'services' %}" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">Services</a>
                    <a href="{% url 'contact' %}" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">Contact</a>
                </div>

                <!-- Mobile Hamburger Menu -->
                <div class="md:hidden">
                    <button id="mobile-menu-toggle" class="text-gray-600 hover:text-gray-900 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobile-nav" class="md:hidden nav-menu">
                <div class="px-2 pt-2 pb-3 space-y-1 border-t border-gray-200">
                    <a href="{% url 'home' %}" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md font-medium">Home</a>
                    <a href="{% url 'about' %}" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md font-medium">About</a>
                    <a href="{% url 'services' %}" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md font-medium">Services</a>
                    <a href="{% url 'contact' %}" class="text-gray-700 hover:bg-gray-100 block px-3 py-2 rounded-md font-medium">Contact</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow py-12 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Welcome Banner -->
            <div class="mb-10 bg-blue-600 rounded-xl shadow-md p-8 text-white">
                <h1 class="text-3xl font-bold mb-2">Smart Contract Escrow System</h1>
                <p class="text-lg text-blue-100">Secure blockchain-based payment processing for supply chain transactions.</p>
            </div>

            <div class="grid md:grid-cols-3 gap-10">
                <!-- Left Column - Supplier Information -->
                <div class="md:col-span-1 space-y-8">
                    <!-- Payment Details Card -->
                    <div class="bg-white rounded-xl shadow-sm p-6 dashboard-card">
                        <h2 class="text-2xl font-semibold text-blue-700 mb-4">Payment Details</h2>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-medium text-blue-800">Supplier Information</h3>
                                <p class="text-gray-700 mt-2">
                                    Payment to:
                                    <span class="font-medium">{{ supplier_name }}</span>
                                </p>
                                <p class="text-gray-700 mt-1">
                                    Wallet address:
                                    <span id="supplierAddressDisplay" class="text-sm font-mono text-gray-600 break-all"></span>
                                </p>
                                <p class="text-gray-700 mt-1">
                                    Negotiation Amount:
                                    <span class="font-medium">{{ amount }} ETH</span>
                                </p>
                            </div>
                            <div>
                                <button id="connectWallet" class="w-full button-primary flex items-center justify-center space-x-2">
                                    <i class="fas fa-wallet mr-2"></i>
                                    <span>Connect Wallet</span>
                                </button>
                                <p id="walletStatus" class="mt-2 text-center text-gray-600">
                                    Not connected
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Console Card -->
                    <div class="bg-white rounded-xl shadow-md p-6 dashboard-card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-terminal mr-2 text-blue-600"></i>
                            Debug Console
                        </h3>
                        <div id="debugConsole" class="debug-console"></div>
                    </div>
                </div>
                
                <!-- Right Column - Payment Process -->
                <div class="md:col-span-2 space-y-8">
                    <div class="bg-white rounded-xl shadow-md p-8 dashboard-card">
                        <h2 class="text-2xl font-semibold text-blue-700 mb-6">Escrow Payment Process</h2>
                        <p id="statusMessage" class="mb-6 text-gray-600">
                            Complete the following steps to process your payment securely.
                        </p>

                        <!-- Step 1 -->
                        <div class="step-container mb-8 pl-12 relative">
                            <div class="step-number absolute left-0 top-0">1</div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Deploy Escrow Contract</h2>
                            <div class="space-y-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <input type="text" id="supplierAddress" placeholder="Enter supplier address (0x...)" 
                                           value="{{ supplier_address }}" 
                                           class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                                    <input type="number" id="totalAmount" placeholder="Total Payment Amount in ETH" 
                                           value="{{ amount }}" step="0.01" min="0.01" 
                                           class="w-full md:w-48 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                                </div>
                                <button id="deployEscrow" class="button-primary">
                                    <i class="fas fa-file-contract mr-2"></i> Deploy Escrow
                                </button>
                                <p id="escrowAddress" class="hidden mt-2 p-2 bg-green-50 text-green-700 rounded-md"></p>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div class="step-container mb-8 pl-12 relative">
                            <div class="step-number absolute left-0 top-0">2</div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Deposit Funds</h2>
                            <button id="depositFunds" class="hidden button-primary">
                                <i class="fas fa-coins mr-2"></i> Deposit ETH to Escrow
                            </button>
                            <p id="depositStatus" class="hidden mt-2 p-2 bg-blue-50 text-blue-700 rounded-md"></p>
                        </div>

                        <!-- Step 3 -->
                        <div class="step-container mb-8 pl-12 relative">
                            <div class="step-number absolute left-0 top-0">3</div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Release Advance (50%)</h2>
                            <button id="releaseAdvance" class="hidden button-primary">
                                <i class="fas fa-paper-plane mr-2"></i> Release Advance
                            </button>
                            <p id="advanceStatus" class="hidden mt-2 p-2 bg-blue-50 text-blue-700 rounded-md"></p>
                        </div>

                        <!-- Step 4 -->
                        <div class="step-container mb-8 pl-12 relative">
                            <div class="step-number absolute left-0 top-0">4</div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Release Final Payment (50%)</h2>
                            <button id="releaseFullPayment" class="hidden button-primary">
                                <i class="fas fa-check-circle mr-2"></i> Release Final Payment
                            </button>
                            <p id="fullPaymentStatus" class="hidden mt-2 p-2 bg-blue-50 text-blue-700 rounded-md"></p>
                        </div>

                        <!-- Step 5 -->
                        <div class="step-container mb-8 pl-12 relative">
                            <div class="step-number absolute left-0 top-0">5</div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Deduct Penalty</h2>
                            <div class="flex items-center">
                                <button id="deductPenalty" class="hidden button-primary bg-yellow-500 hover:bg-yellow-600">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> Deduct Penalty
                                </button>
                                <span class="ml-3 text-gray-500 text-sm">(Alternative to Step 4 if supplier performance is unsatisfactory)</span>
                            </div>
                            <p id="penaltyStatus" class="hidden mt-2 p-2 bg-yellow-50 text-yellow-700 rounded-md"></p>
                        </div>
                    </div>

                    <!-- Payment Information Section -->
                    <div class="bg-white rounded-xl shadow-md p-8 dashboard-card">
                        <h2 class="text-2xl font-semibold text-blue-700 mb-6">Payment Information</h2>
                        <div class="space-y-6">
                            <div class="flex items-start space-x-4">
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i class="fas fa-shield-alt text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-lg mb-1">Escrow Security</h3>
                                    <p class="text-gray-600">Our smart contract escrow system guarantees secure transactions between manufacturers and suppliers.</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-4">
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i class="fas fa-hand-holding-usd text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-lg mb-1">Payment Structure</h3>
                                    <p class="text-gray-600">The payment is split into two phases: 50% advance payment and 50% after completion.</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-4">
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i class="fas fa-exclamation-circle text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-lg mb-1">Important Notice</h3>
                                    <p class="text-gray-600">Make sure to verify the supplier's wallet address before deploying the escrow contract.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300 py-12">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-4 gap-8 mb-8">
                <div>
                    <div class="flex items-center space-x-2 mb-6">
                        <div class="flex items-center justify-center h-10 w-10 rounded-md bg-blue-600 text-white">
                            <i class="fas fa-link text-lg"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white">Supply<span class="text-blue-400">Chain</span></h1>
                    </div>
                    <p class="text-gray-400 mb-4">Connecting manufacturers and suppliers through innovative technology.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <i class="fab fa-facebook"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4 text-white">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="{% url 'home' %}" class="text-gray-400 hover:text-blue-400 transition">Home</a></li>
                        <li><a href="{% url 'about' %}" class="text-gray-400 hover:text-blue-400 transition">About Us</a></li>
                        <li><a href="{% url 'services' %}" class="text-gray-400 hover:text-blue-400 transition">Services</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-blue-400 transition">Blog</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4 text-white">Support</h3>
                    <ul class="space-y-2">
                        <li><a href="{% url 'faq' %}" class="text-gray-400 hover:text-blue-400 transition">FAQ</a></li>
                        <li><a href="{% url 'contact' %}" class="text-gray-400 hover:text-blue-400 transition">Contact Support</a></li>
                        <li><a href="{% url 'terms' %}" class="text-gray-400 hover:text-blue-400 transition">Terms & Conditions</a></li>
                        <li><a href="{% url 'privacy' %}" class="text-gray-400 hover:text-blue-400 transition">Privacy Policy</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4 text-white">Contact Us</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <i class="fas fa-map-marker-alt mt-1 mr-3 text-blue-400"></i>
                            <span>123 Supply Chain Blvd, Business District, 10001</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-3 text-blue-400"></i>
                            <span>info@supplychain.com</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-3 text-blue-400"></i>
                            <span>+1 (555) 123-4567</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="pt-8 mt-8 border-t border-gray-700 text-center text-gray-400">
                <p>© 2025 Supply Chain Portal. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);

        // Set values from URL
        const addressFromURL = urlParams.get("supplier_address");

        if (addressFromURL) {
          document.getElementById("supplierAddress").value = addressFromURL;
        }

        const amountFromURL = urlParams.get("amount");
        document.getElementById("supplierAddressDisplay").textContent =
          urlParams.get("supplier_address");
      });

      let provider, signer, factoryContract, escrowContract;
      let escrowAddress = "";
      let userAddress = "";

      // Debugging utility
      function debugLog(message, isError = false) {
        const consoleDiv = document.getElementById("debugConsole");
        const messageDiv = document.createElement("div");

        const timestamp = document.createElement("span");
        timestamp.className = "debug-timestamp";
        timestamp.textContent = `[${new Date().toLocaleTimeString()}]`;

        const msgSpan = document.createElement("span");
        msgSpan.className = isError
          ? "debug-message debug-error"
          : "debug-message";
        msgSpan.textContent = message;

        messageDiv.appendChild(timestamp);
        messageDiv.appendChild(msgSpan);
        consoleDiv.appendChild(messageDiv);

        // Auto-scroll to bottom
        consoleDiv.scrollTop = consoleDiv.scrollHeight;

        // Also log to browser console
        if (isError) {
          console.error(message);
        } else {
          console.log(message);
        }
      }

      // Factory contract address
      const factoryAddress = "0xaEcE4f81959EDE13e64c759D4ea5eaDa458D700C";

      // Factory contract ABI
      const factoryAbi = [
        {
          inputs: [
            { internalType: "address", name: "_supplier", type: "address" },
            { internalType: "uint256", name: "_totalAmount", type: "uint256" },
          ],
          name: "createEscrow",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [
            { indexed: true, name: "escrowAddress", type: "address" },
            { indexed: true, name: "manufacturer", type: "address" },
            { indexed: true, name: "supplier", type: "address" },
            { name: "totalAmount", type: "uint256" },
          ],
          name: "EscrowCreated",
          type: "event",
        },
      ];

      // Updated Escrow contract ABI with SupplierPartialPayment event
      const escrowAbi = [
        {
          inputs: [],
          name: "deposit",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "releaseAdvance",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "releaseFullPayment",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "deductPenalty",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "manufacturer",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "supplier",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "totalAmount",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "advanceReleased",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "fullPaymentReleased",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "FundsDeposited",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "AdvanceReleased",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "FullPaymentReleased",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "PenaltyDeducted",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "SupplierPartialPayment",
          type: "event",
        },
      ];

      // Connect MetaMask
      // Wallet connection function
      document.getElementById("connectWallet").onclick = async () => {
        try {
          debugLog("Attempting to connect wallet...");

          // Check if MetaMask is installed
          if (!window.ethereum) {
            throw new Error("Please install MetaMask or another Web3 wallet");
          }

          // Initialize Web3 provider
          provider = new ethers.providers.Web3Provider(window.ethereum);
          debugLog("Web3 provider initialized");

          // Request account access
          const accounts = await provider.send("eth_requestAccounts", []);
          userAddress = accounts[0];
          debugLog(`Connected account: ${userAddress}`);

          // Get signer
          signer = provider.getSigner();

          // Update UI
          document.getElementById(
            "walletStatus"
          ).textContent = `Connected: ${userAddress.substring(
            0,
            6
          )}...${userAddress.substring(38)}`;
          document.getElementById("walletStatus").className = "status";

          debugLog("Wallet connected successfully");

          // Initialize contract instances
          factoryContract = new ethers.Contract(
            factoryAddress,
            factoryAbi,
            signer
          );
          debugLog("Factory contract instance created");
        } catch (error) {
          debugLog(`Wallet connection failed: ${error.message}`, true);
          document.getElementById(
            "walletStatus"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("walletStatus").className = "error";
        }
      };

      // Deploy a new escrow contract
      document.getElementById("deployEscrow").onclick = async () => {
        const btn = document.getElementById("deployEscrow");
        const originalText = btn.textContent;
        try {
          // Check if wallet is connected
          if (!signer) throw new Error("Please connect your wallet first");

          // Now safe to access inputs
          const supplierAddress = document
            .getElementById("supplierAddress")
            .value.trim();
          const totalAmountInput = document
            .getElementById("totalAmount")
            .value.trim();

          if (!supplierAddress) throw new Error("Supplier address is required");
          if (!totalAmountInput) throw new Error("Total amount is required");
          if (!ethers.utils.isAddress(supplierAddress))
            throw new Error("Invalid supplier address");

          const totalAmount = ethers.utils.parseEther(totalAmountInput);
          if (totalAmount.lte(0))
            throw new Error("Amount must be greater than 0");

          btn.disabled = true;
          btn.textContent = "Deploying...";
          debugLog("Sending deployment transaction...");

          const tx = await factoryContract.createEscrow(
            supplierAddress,
            totalAmount
          );
          debugLog(`Transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Transaction sent, waiting for confirmation...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Transaction mined in block: ${receipt.blockNumber}`);
          debugLog(`Gas used: ${receipt.gasUsed.toString()}`);

          // Parse the event to get the escrow address
          const event = receipt.events?.find(
            (e) => e.event === "EscrowCreated"
          );
          if (!event)
            throw new Error("EscrowCreated event not found in receipt");

          escrowAddress = event.args.escrowAddress;
          debugLog(`Escrow deployed at: ${escrowAddress}`);

          document.getElementById(
            "escrowAddress"
          ).textContent = `Escrow Deployed at: ${escrowAddress}`;
          document.getElementById("escrowAddress").classList.remove("hidden");

          // Initialize escrow contract instance
          escrowContract = new ethers.Contract(
            escrowAddress,
            escrowAbi,
            signer
          );
          debugLog("Escrow contract instance created");

          // Show deposit button (new step)
          document.getElementById("depositFunds").classList.remove("hidden");

          document.getElementById("statusMessage").textContent =
            "Escrow deployed successfully! Now deposit funds.";
          document.getElementById("statusMessage").className = "success";

          // Log contract details
          const [manufacturer, supplier, amount] = await Promise.all([
            escrowContract.manufacturer(),
            escrowContract.supplier(),
            escrowContract.totalAmount(),
          ]);
          debugLog(`Contract initialized with:
              Manufacturer: ${manufacturer}
              Supplier: ${supplier}
              Amount: ${ethers.utils.formatEther(amount)} ETH`);
        } catch (error) {
          debugLog(`Escrow deployment failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      };

      // Deposit funds into escrow
      document.getElementById("depositFunds").onclick = async () => {
        const btn = document.getElementById("depositFunds");
        const statusElement = document.getElementById("depositStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          const totalAmountInput = document
            .getElementById("totalAmount")
            .value.trim();
          if (!totalAmountInput) throw new Error("Total amount is required");

          const amount = ethers.utils.parseEther(totalAmountInput);
          debugLog(`Attempting to deposit ${totalAmountInput} ETH into escrow`);

          btn.disabled = true;
          btn.textContent = "Depositing...";
          statusElement.textContent = `Depositing ${totalAmountInput} ETH...`;
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for deposit event
          escrowContract.on("FundsDeposited", (amount) => {
            const ethAmount = ethers.utils.formatEther(amount);
            debugLog(`Event: FundsDeposited - ${ethAmount} ETH`);
            statusElement.textContent = `Deposited ${ethAmount} ETH into escrow`;
            statusElement.className = "success";
          });

          const tx = await escrowContract.deposit({ value: amount });
          debugLog(`Deposit transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Deposit transaction sent...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Deposit confirmed in block: ${receipt.blockNumber}`);

          // Show next steps
          document.getElementById("releaseAdvance").classList.remove("hidden");
          document.getElementById("deductPenalty").classList.remove("hidden");

          document.getElementById("statusMessage").textContent =
            "Funds deposited! You can now release payments.";
          document.getElementById("statusMessage").className = "success";

          // Check new balance
          const balance = await escrowContract.getBalance();
          debugLog(
            `Current contract balance: ${ethers.utils.formatEther(balance)} ETH`
          );
        } catch (error) {
          debugLog(`Deposit failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("FundsDeposited");
        }
      };

      // Release advance payment
      document.getElementById("releaseAdvance").onclick = async () => {
        const btn = document.getElementById("releaseAdvance");
        const statusElement = document.getElementById("advanceStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          debugLog("Attempting to release advance payment...");

          btn.disabled = true;
          btn.textContent = "Processing...";
          statusElement.textContent = "Releasing advance payment...";
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for advance release event
          escrowContract.on("AdvanceReleased", (amount) => {
            const ethAmount = ethers.utils.formatEther(amount);
            debugLog(`Event: AdvanceReleased - ${ethAmount} ETH`);
            statusElement.textContent = `Released advance of ${ethAmount} ETH to supplier`;
            statusElement.className = "success";
          });

          const tx = await escrowContract.releaseAdvance({ gasLimit: 100000 });
          debugLog(`Release advance transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Releasing advance...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(
            `Advance release confirmed in block: ${receipt.blockNumber}`
          );

          // Show final payment button
          document
            .getElementById("releaseFullPayment")
            .classList.remove("hidden");

          document.getElementById("statusMessage").textContent =
            "Advance payment released!";
          document.getElementById("statusMessage").className = "success";

          // Check contract state
          const [released, balance] = await Promise.all([
            escrowContract.advanceReleased(),
            escrowContract.getBalance(),
          ]);
          debugLog(
            `Advance released: ${released}, Remaining balance: ${ethers.utils.formatEther(
              balance
            )} ETH`
          );
        } catch (error) {
          debugLog(`Advance release failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("AdvanceReleased");
        }
      };

      // Release full payment
      document.getElementById("releaseFullPayment").onclick = async () => {
        const btn = document.getElementById("releaseFullPayment");
        const statusElement = document.getElementById("fullPaymentStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          debugLog("Attempting to release final payment...");

          btn.disabled = true;
          btn.textContent = "Processing...";
          statusElement.textContent = "Releasing final payment...";
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for full payment event
          escrowContract.on("FullPaymentReleased", (amount) => {
            const ethAmount = ethers.utils.formatEther(amount);
            debugLog(`Event: FullPaymentReleased - ${ethAmount} ETH`);
            statusElement.textContent = `Released final payment of ${ethAmount} ETH to supplier`;
            statusElement.className = "success";
          });

          const tx = await escrowContract.releaseFullPayment({
            gasLimit: 100000,
          });
          debugLog(`Final payment transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Releasing final payment...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Final payment confirmed in block: ${receipt.blockNumber}`);

          // Hide penalty button
          document.getElementById("deductPenalty").style.display = "none";

          document.getElementById("statusMessage").textContent =
            "All payments completed!";
          document.getElementById("statusMessage").className = "success";

          // Check final state
          const [advanceReleased, fullReleased, balance] = await Promise.all([
            escrowContract.advanceReleased(),
            escrowContract.fullPaymentReleased(),
            escrowContract.getBalance(),
          ]);
          debugLog(`Final state:
              Advance released: ${advanceReleased}
              Full payment released: ${fullReleased}
              Contract balance: ${ethers.utils.formatEther(balance)} ETH`);
        } catch (error) {
          debugLog(`Final payment failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("FullPaymentReleased");
        }
      };

      // Deduct penalty (updated for 50/50 split)
      document.getElementById("deductPenalty").onclick = async () => {
        const btn = document.getElementById("deductPenalty");
        const statusElement = document.getElementById("penaltyStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          debugLog(
            "Attempting to deduct penalty and send remaining to supplier..."
          );

          // First check contract state
          const [advanceReleased, fullReleased, balance] = await Promise.all([
            escrowContract.advanceReleased(),
            escrowContract.fullPaymentReleased(),
            escrowContract.getBalance(),
          ]);
          debugLog(`Pre-penalty check:
              Advance released: ${advanceReleased}
              Full payment released: ${fullReleased}
              Balance: ${ethers.utils.formatEther(balance)} ETH`);

          if (!advanceReleased)
            throw new Error("Advance must be released first");
          if (fullReleased) throw new Error("Cannot deduct after full payment");
          if (balance.eq(0)) throw new Error("No funds available for penalty");

          btn.disabled = true;
          btn.textContent = "Processing...";
          statusElement.textContent =
            "Processing penalty and partial payment...";
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for both events
          let penaltyAmount, supplierAmount;

          escrowContract.on("PenaltyDeducted", (amount) => {
            penaltyAmount = ethers.utils.formatEther(amount);
            debugLog(
              `Event: PenaltyDeducted - ${penaltyAmount} ETH to manufacturer`
            );
          });

          escrowContract.on("SupplierPartialPayment", (amount) => {
            supplierAmount = ethers.utils.formatEther(amount);
            debugLog(
              `Event: SupplierPartialPayment - ${supplierAmount} ETH to supplier`
            );
            statusElement.innerHTML = `
                Penalty processed!<br>
                • ${penaltyAmount} ETH sent to manufacturer<br>
                • ${supplierAmount} ETH sent to supplier
              `;
            statusElement.className = "success";
          });

          const tx = await escrowContract.deductPenalty({ gasLimit: 100000 });
          debugLog(`Penalty transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Processing penalty and partial payment...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Transaction confirmed in block: ${receipt.blockNumber}`);

          // Hide payment buttons after penalty
          document.getElementById("releaseFullPayment").style.display = "none";
          document.getElementById("deductPenalty").style.display = "none";

          document.getElementById("statusMessage").textContent =
            "Penalty and partial payment completed!";
          document.getElementById("statusMessage").className = "success";

          // Verify final state
          const newBalance = await escrowContract.getBalance();
          debugLog(
            `Final contract balance: ${ethers.utils.formatEther(
              newBalance
            )} ETH (should be 0)`
          );
        } catch (error) {
          let errorMsg = error.message;
          if (error.message.includes("execution reverted")) {
            errorMsg =
              "Cannot process penalty. Check:\n- Advance must be released first\n- Full payment not completed\n- Contract has sufficient balance";
          }

          debugLog(`Penalty processing failed: ${errorMsg}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${errorMsg}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("PenaltyDeducted");
          escrowContract.removeAllListeners("SupplierPartialPayment");
        }
      };

      // Initialize UI
      document.addEventListener("DOMContentLoaded", () => {
        debugLog("Application initialized");
      });
    </script>
</body>
</html>